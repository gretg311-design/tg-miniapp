<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --neon: #bc13fe; --glass: rgba(20, 10, 30, 0.95); }
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; }
        .screen { display: none; height: 100vh; flex-direction: column; padding: 20px; box-sizing: border-box; overflow-y: auto; padding-bottom: 80px; }
        .active { display: flex; }
        .glass { background: var(--glass); border: 1px solid var(--neon); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .menu-btn { height: 70px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--neon); border-radius: 12px; font-size: 12px; font-weight: bold; background: rgba(188, 19, 254, 0.1); }
        .btn-main { width: 100%; padding: 15px; background: var(--neon); border: none; color: #fff; border-radius: 10px; font-weight: bold; }
        .nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #000; border-top: 1px solid var(--neon); display: flex; justify-content: center; align-items: center; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #111; border: 1px solid var(--neon); color: #fff; border-radius: 8px; }
    </style>
</head>
<body>

<div id="scr-reg" class="screen active" style="justify-content: center;">
    <div class="glass">
        <h2 style="text-align: center; color: var(--neon);">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</h2>
        <input id="r-name" placeholder="–í–∞—à–µ –∏–º—è">
        <select id="r-gen"><option value="–ú">–ú—É–∂—Å–∫–æ–π</option><option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π</option></select>
        <button class="btn-main" onclick="auth()">–í–û–ô–¢–ò</button>
    </div>
</div>

<div id="scr-main" class="screen">
    <div class="glass" style="display: flex; justify-content: space-between;">
        <span id="u-name">...</span>
        <span id="u-bal">üåô 0</span>
    </div>
    <div class="menu-grid">
        <div class="menu-btn" onclick="show('shop')">–ú–ê–ì–ê–ó–ò–ù</div>
        <div class="menu-btn" onclick="show('tasks')">–ó–ê–î–ê–ù–ò–Ø</div>
        <div class="menu-btn" onclick="show('daily')">–ï–ñ–ï–î–ù–ï–í–ö–ê</div>
        <div class="menu-btn" onclick="show('profile')">–ü–†–û–§–ò–õ–¨</div>
        <div id="btn-adm" class="menu-btn" style="display:none; color: red;" onclick="show('admin')">–ê–î–ú–ò–ù–ö–ê</div>
    </div>
</div>

<div id="scr-mod" class="screen">
    <div id="mod-cont"></div>
    <button class="btn-main" onclick="show('main')">–ù–ê–ó–ê–î</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    let user = {}, tasks = [];

    async function auth() {
        const raw = tg.initDataUnsafe.user || {id: "8287041036", first_name: "Boss"};
        const res = await fetch('/api/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: raw.id, name: document.getElementById('r-name').value, gender: document.getElementById('r-gen').value})
        });
        const data = await res.json();
        user = data.user; tasks = data.tasks;
        show('main');
    }

    function show(scr) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        if (scr === 'main') {
            document.getElementById('scr-main').classList.add('active');
            document.getElementById('u-name').innerText = user.name + (user.role==='owner'?' (BOSS)':'');
            document.getElementById('u-bal').innerText = "üåô " + user.balance;
            if(user.role==='owner' || user.role==='admin') document.getElementById('btn-adm').style.display='flex';
        } else {
            document.getElementById('scr-mod').classList.add('active');
            renderMod(scr);
        }
    }

    function renderMod(type) {
        const cont = document.getElementById('mod-cont');
        if (type === 'admin') {
            cont.innerHTML = `<div class="glass"><h3>–ö–û–ù–°–û–õ–¨ –ü–û ID</h3>
                <input id="tid" placeholder="Telegram ID">
                <input id="tval" placeholder="–ö–æ–ª-–≤–æ / –†–æ–ª—å">
                <button class="btn-main" onclick="adminAct('addBalance')">–î–ê–¢–¨ –®–ê–†–î–´</button>
                <button class="btn-main" style="margin-top:5px;" onclick="adminAct('setRole')">–î–ê–¢–¨ –†–û–õ–¨</button>
            </div>`;
        } else if (type === 'daily') {
            cont.innerHTML = `<div class="glass"><h3>–ï–ñ–ï–î–ù–ï–í–ö–ê</h3><p>–¢–≤–æ–π —Å—Ç—Ä–∏–∫: ${user.streak} –¥–Ω.</p><button class="btn-main" onclick="getDaily()">–ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–£</button></div>`;
        } else if (type === 'profile') {
            cont.innerHTML = `<div class="glass"><h3>–ü–†–û–§–ò–õ–¨</h3><p>ID: ${user.id}</p><p>–ü–æ–¥–ø–∏—Å–∫–∞: ${user.sub}</p></div>`;
        }
    }

    async function adminAct(action) {
        await fetch('/api/admin/control', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({senderId: user.id, targetId: document.getElementById('tid').value, value: document.getElementById('tval').value, action})
        });
        tg.showAlert("–ì–æ—Ç–æ–≤–æ");
    }

    async function getDaily() {
        const res = await fetch('/api/daily', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({userId: user.id}) });
        const d = await res.json(); user.balance = d.balance; user.streak = d.streak; show('main');
    }

    tg.expand();
</script>
</body>
</html>
