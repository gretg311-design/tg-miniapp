<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–õ—É–Ω–∞: –û—Ç –ê –¥–æ –Ø</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --purp: #6a0dad; --light-purp: #a37cf7; --glass: rgba(255, 255, 255, 0.08); --bg: #050505; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        #loading-screen { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .moon { width: 120px; height: 120px; background: radial-gradient(circle at 30% 30%, var(--light-purp), var(--purp)); border-radius: 50%; box-shadow: 0 0 50px var(--purp); animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); box-shadow: 0 0 80px var(--purp); } }
        .disclaimer { position: absolute; bottom: 20px; right: 20px; font-size: 10px; color: #444; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; padding: 20px; height: calc(100vh - 70px); overflow-y: auto; box-sizing: border-box; }
        .active { display: block; }
        
        /* –ú–µ–Ω—é */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn-menu { background: var(--glass); border: 1px solid var(--purp); padding: 18px; border-radius: 12px; color: white; text-align: center; font-weight: bold; cursor: pointer; }
        .shop-btn { grid-column: span 2; border: 2px solid #ffd700; background: linear-gradient(90deg, #1a1a1a, #000); }

        /* –ß–∞—Ç */
        .chat-item { display: flex; justify-content: space-between; align-items: center; background: var(--glass); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 3px solid var(--purp); }
        .chat-dots { font-size: 24px; cursor: pointer; padding: 0 10px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .setting-row { margin-bottom: 25px; }
        input[type=range] { width: 100%; accent-color: var(--purp); }

        /* –ü–∞–Ω–µ–ª–∏ */
        .top-bar { display: flex; justify-content: space-between; padding: 15px; background: #0a0a0a; border-bottom: 1px solid var(--purp); }
        .nav-bar { position: fixed; bottom: 0; width: 100%; display: flex; height: 60px; background: #000; border-top: 1px solid var(--purp); z-index: 500; }
        .nav-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; }

        #chat-input-area { position: fixed; bottom: 65px; width: 100%; background: #111; padding: 10px; display: none; box-sizing: border-box; }
        input[disabled] { opacity: 0.5; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="moon"></div>
        <p style="margin-top:20px; letter-spacing: 2px; font-size: 14px;">–ó–ê–ì–†–£–ó–ö–ê –õ–£–ù–´...</p>
        <div class="disclaimer">–≤—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –≤—ã–º—ã—à–ª–µ–Ω—ã –∏ –∏—Ö –∏—Å—Ç–æ—Ä–∏–∏</div>
    </div>

    <div id="captcha-screen" class="screen" style="text-align:center; padding-top:80px;">
        <h1 style="color:red; font-size:70px; margin:0;">18+</h1>
        <p>–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö. –í–∞–º –µ—Å—Ç—å 18 –ª–µ—Ç?</p>
        <button class="btn-menu" onclick="showScreen('reg-screen')" style="width:200px">–î–ê, –ú–ù–ï –ï–°–¢–¨ 18</button>
    </div>

    <div id="reg-screen" class="screen">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input type="text" id="reg-name" placeholder="–í–∞—à–µ –ò–º—è" class="btn-menu" style="width:100%; margin-bottom:15px; text-align:left;">
        <select id="reg-gender" class="btn-menu" style="width:100%; text-align:left;">
            <option value="–ú—É–∂—Å–∫–æ–π">–ú—É–∂—Å–∫–æ–π</option>
            <option value="–ñ–µ–Ω—Å–∫–∏–π">–ñ–µ–Ω—Å–∫–∏–π</option>
        </select>
        <button class="btn-menu" style="width:100%; margin-top:30px; border-color: gold;" onclick="finishReg()">–ü–û–õ–£–ß–ò–¢–¨ ULTRA –ù–ê 7 –î–ù–ï–ô</button>
    </div>

    <div id="main-menu" class="screen">
        <div class="top-bar">
            <div><b id="u-name">...</b><br><small id="u-id" style="color:#888"></small></div>
            <div style="text-align:right"><span id="u-bal">0</span> üíé<br><small id="u-sub" style="color:var(--light-purp)"></small></div>
        </div>
        <div class="menu-grid">
            <div class="btn-menu" onclick="showScreen('chats-screen')">–ß–ê–¢–´</div>
            <div class="btn-menu" onclick="showScreen('chars-screen')">–ü–ï–†–°–û–ù–ê–ñ–ò</div>
            <div class="btn-menu" onclick="claimDaily()">–ï–ñ–ï–î–ù–ï–í–ö–ê</div>
            <div class="btn-menu" onclick="showScreen('promo-screen')">–ü–†–û–ú–û–ö–û–î–´</div>
            <div class="btn-menu" onclick="showScreen('profile-screen')">–ü–†–û–§–ò–õ–¨</div>
            <div class="btn-menu" onclick="showScreen('settings-screen')">–ù–ê–°–¢–†–û–ô–ö–ò</div>
            <div id="admin-btn" class="btn-menu" style="display:none" onclick="showScreen('admin-screen')">–ê–î–ú–ò–ù</div>
            <div id="console-btn" class="btn-menu" style="display:none" onclick="showScreen('console-screen')">–ö–û–ù–°–û–õ–¨</div>
            <div class="btn-menu shop-btn" onclick="showScreen('shop-screen')">–ú–ê–ì–ê–ó–ò–ù</div>
        </div>
    </div>

    <div id="chats-screen" class="screen">
        <h3>–í–∞—à–∏ —á–∞—Ç—ã</h3>
        <div id="chats-list">
            <div class="chat-item">
                <div onclick="openChat('–ê–∫–∏—Ä–∞')"><b>–ê–∫–∏—Ä–∞</b><br><small>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...</small></div>
                <div class="chat-dots" onclick="openChatMenu('–ê–∫–∏—Ä–∞')">‚ãÆ</div>
            </div>
        </div>
    </div>

    <div id="settings-screen" class="screen">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="setting-row">
            <label>–î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ (–æ—Ç 45 —Å–ª–æ–≤): <span id="val-len">45</span></label>
            <input type="range" min="45" max="100" value="45" oninput="updateSetting('msgLength', this.value)">
        </div>
        <div class="setting-row">
            <label>–ü–æ—à–ª–æ—Å—Ç—å: <span id="val-lewd">–ú–∏–Ω–∏–º—É–º</span></label>
            <input type="range" min="1" max="4" value="1" oninput="updateSetting('lewdness', this.value)">
        </div>
        <button class="btn-menu" style="width:100%" onclick="showScreen('main-menu')">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <div id="chat-modal" class="modal" onclick="this.style.display='none'">
        <div style="background:#111; width:80%; border-radius:15px; padding:20px;" onclick="event.stopPropagation()">
            <h4 id="modal-char-name">–ü–µ—Ä—Å–æ–Ω–∞–∂</h4>
            <button class="btn-menu" style="width:100%; margin-bottom:10px;">‚≠ê –í –ò–ó–ë–†–ê–ù–ù–û–ï</button>
            <button class="btn-menu" style="width:100%; margin-bottom:10px;" onclick="clearMemory()">üß† –°–¢–ï–†–ï–¢–¨ –ü–ê–ú–Ø–¢–¨</button>
            <button class="btn-menu" style="width:100%; border-color:red; color:red;" onclick="deleteChat()">üóëÔ∏è –£–î–ê–õ–ò–¢–¨ –ß–ê–¢</button>
        </div>
    </div>

    <div class="nav-bar" id="nav-bar" style="display:none;">
        <div class="nav-btn" onclick="showScreen('main-menu')">üè† –î–û–ú–û–ô</div>
        <div class="nav-btn" onclick="goBack()">‚¨ÖÔ∏è –ù–ê–ó–ê–î</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        let user = null;
        let history = ['main-menu'];

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(!['loading-screen','captcha-screen','reg-screen'].includes(id)) {
                document.getElementById('nav-bar').style.display = 'flex';
                if(history[history.length-1] !== id) history.push(id);
            }
        }

        function goBack() {
            if(history.length > 1) {
                history.pop();
                showScreen(history[history.length-1]);
            }
        }

        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            showScreen('captcha-screen');
        }, 3000);

        async function finishReg() {
            const name = document.getElementById('reg-name').value;
            const gender = document.getElementById('reg-gender').value;
            if(!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

            const res = await fetch('/api/auth', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tgId: tg.initDataUnsafe?.user?.id || 123, name, gender })
            });
            user = await res.json();
            updateUI();
            showScreen('main-menu');
        }

        function updateUI() {
            document.getElementById('u-name').innerText = user.name;
            document.getElementById('u-id').innerText = user.tgId;
            document.getElementById('u-bal').innerText = user.balance;
            document.getElementById('u-sub').innerText = user.subscription + (user.subscription === 'Ultra' ? ' ‚ö°' : '');
            
            if(['admin','owner'].includes(user.role)) document.getElementById('admin-btn').style.display = 'block';
            if(user.role === 'owner') document.getElementById('console-btn').style.display = 'block';
        }

        function updateSetting(type, val) {
            if(type === 'msgLength') document.getElementById('val-len').innerText = val;
            if(type === 'lewdness') {
                const levels = ["", "–ú–∏–Ω–∏–º—É–º", "–°—Ä–µ–¥–Ω—è—è", "–°–∏–ª—å–Ω–∞—è", "–ú–ê–ö–°–ò–ú–£–ú"];
                document.getElementById('val-lewd').innerText = levels[val];
            }
        }

        function openChatMenu(name) {
            document.getElementById('modal-char-name').innerText = name;
            document.getElementById('chat-modal').style.display = 'flex';
        }

        async function claimDaily() {
            const res = await fetch('/api/daily', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tgId: user.tgId })
            });
            const data = await res.json();
            tg.showAlert(data.success ? `–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${data.reward} üíé` : data.msg);
            if(data.success) { user.balance = data.balance; updateUI(); }
        }
    </script>
</body>
</html>
