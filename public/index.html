<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0b0f1a; --card: #161b2c; --accent: #3b82f6; --gold: #fbc02d; }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { margin: 0; background: var(--bg); color: white; overflow: hidden; height: 100vh; }
        .screen { display: none; height: 100vh; overflow-y: auto; padding-bottom: 80px; }
        .active { display: block; }
        
        /* –ü–£–õ–¨–°–ò–†–£–Æ–©–ê–Ø –õ–£–ù–ê */
        #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .moon { font-size: 80px; filter: drop-shadow(0 0 20px #3b82f6); animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%,100% {transform:scale(1); opacity:0.8;} 50% {transform:scale(1.2); opacity:1;} }

        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card); border-bottom: 1px solid #232d4b; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .btn { background: var(--card); padding: 22px 10px; border-radius: 18px; text-align: center; border: 1px solid #232d4b; font-weight: bold; font-size: 11px; }
        .card { background: var(--card); margin: 10px 15px; padding: 15px; border-radius: 15px; border: 1px solid #232d4b; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; background: #0b1121; border: 1px solid var(--accent); color: white; border-radius: 10px; }
        .adm-btn { grid-column: span 2; background: #ef4444; color: white; border: none; padding: 20px; border-radius: 18px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading"><div class="moon">üåô</div><p>–ó–ê–ì–†–£–ó–ö–ê...</p></div>

    <div id="scr-main" class="screen">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="u-i" src="" style="width:45px; border-radius:50%; border:2px solid var(--accent);">
                <div><b id="u-n">...</b><br><span id="u-r" style="font-size:10px; color:var(--gold)">USER</span></div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:10px; color:var(--accent)" id="u-prem">PREM: –ù–ï–¢</div>
                <div style="background:#1e253d; padding:5px 12px; border-radius:20px; font-weight:bold;">üåô <span id="u-b">0</span></div>
            </div>
        </div>
        <div class="menu-grid">
            <div class="btn" onclick="tab('scr-chats')">üí¨ –ß–ê–¢–´</div>
            <div class="btn" onclick="tab('scr-chars')">üßç –ì–ï–†–û–ò</div>
            <div class="btn" onclick="tg.showAlert('–ë–æ–Ω—É—Å +10üåô')">üéÅ –ë–û–ù–£–°</div>
            <div class="btn" onclick="tab('scr-tasks')">üìã –ó–ê–î–ê–ù–ò–Ø</div>
            <div class="btn" onclick="tab('scr-shop')">üõí –ú–ê–ì–ê–ó–ò–ù</div>
            <div class="btn" onclick="tg.showAlert('–ö–æ–¥–æ–≤ –Ω–µ—Ç')">üéü –ö–û–î–´</div>
            <div class="btn" onclick="tg.showAlert('–ü—Ä–æ—Ñ–∏–ª—å')">üë§ –ü–†–û–§–ò–õ–¨</div>
            <div class="btn" onclick="tg.showAlert('–û–ø—Ü–∏–∏')">‚öôÔ∏è –û–ü–¶–ò–ò</div>
            <div class="btn" onclick="tg.showAlert('–ò–≤–µ–Ω—Ç—ã')">üì¢ –ò–í–ï–ù–¢–´</div>
            <div class="btn" onclick="tg.showAlert('–¢–æ–ø')">üèÜ –¢–û–ü</div>
            <button id="god" class="adm-btn" style="display:none;" onclick="tab('scr-admin')">üíª –ê–î–ú–ò–ù–ö–ê</button>
        </div>
    </div>

    <div id="scr-admin" class="screen">
        <h2 style="padding:15px;">–ü–∞–Ω–µ–ª—å –ë–æ–≥–∞</h2>
        <div class="card">
            <h3>–°–æ–∑–¥–∞—Ç—å (–ê–¥–º–∏–Ω+)</h3>
            <input type="text" id="a-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ/–ò–º—è">
            <input type="text" id="a-link" placeholder="–°—Å—ã–ª–∫–∞/–û–ø–∏—Å–∞–Ω–∏–µ">
            <button onclick="adm('add_task')" style="background:green; color:white; width:100%; padding:10px; border-radius:8px; border:none; margin-bottom:5px;">+ –ó–ê–î–ê–ù–ò–ï</button>
            <button onclick="adm('add_char')" style="background:blue; color:white; width:100%; padding:10px; border-radius:8px; border:none;">+ –ì–ï–†–û–Ø</button>
        </div>

        <div id="ow-tools" style="display:none;">
            <div class="card" style="border-color:red;">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–û–≤–Ω–µ—Ä)</h3>
                <input type="number" id="t-id" placeholder="ID —é–∑–µ—Ä–∞">
                <input type="number" id="t-amt" placeholder="–ö–æ–ª-–≤–æ –æ—Å–∫–æ–ª–∫–æ–≤">
                <button onclick="adm('edit_balance', 'add')" style="width:48%; background:green; color:white; padding:10px; border-radius:8px; border:none;">–í–´–î–ê–¢–¨</button>
                <button onclick="adm('edit_balance', 'sub')" style="width:48%; background:red; color:white; padding:10px; border-radius:8px; border:none;">–ó–ê–ë–†–ê–¢–¨</button>
                
                <h4 style="margin:15px 0 5px;">–í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</h4>
                <select id="p-type"><option value="VIP">VIP</option><option value="GOD">GOD</option></select>
                <input type="text" id="p-days" placeholder="–°—Ä–æ–∫ (–Ω–∞–ø—Ä. 30 –¥–Ω–µ–π)">
                <button onclick="adm('set_prem')" style="width:100%; background:var(--gold); color:black; font-weight:bold; padding:12px; border-radius:8px; border:none;">–í–´–î–ê–¢–¨ –ü–û–î–ü–ò–°–ö–£</button>
            </div>
            <div class="card">
                <h3>–õ–æ–≥–∏</h3>
                <div id="l-box" style="font-size:10px; height:100px; overflow-y:auto; background:#000; padding:5px;"></div>
            </div>
        </div>
        <button class="btn" style="width:90%; margin:10px 5%;" onclick="tab('scr-main')">–ù–ê–ó–ê–î</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        let role = 'user';

        function tab(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        async function init() {
            const res = await fetch('/api/data/' + tg.initDataUnsafe.user.id);
            const data = await res.json();
            document.getElementById('loading').style.display = 'none';
            if(!data.user) { /* –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–∞–∫ –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ */ return; }

            role = data.role;
            document.getElementById('u-n').innerText = data.user.name;
            document.getElementById('u-b').innerText = data.user.balance;
            document.getElementById('u-r').innerText = role.toUpperCase();
            document.getElementById('u-prem').innerText = "PREM: " + data.user.premium;
            document.getElementById('u-i').src = tg.initDataUnsafe.user.photo_url || "";

            if(role !== 'user') document.getElementById('god').style.display = 'block';
            if(role === 'owner') {
                document.getElementById('ow-tools').style.display = 'block';
                document.getElementById('l-box').innerHTML = data.logs.map(l => `<div>${l}</div>`).join('');
            }
            tab('scr-main');
        }

        async function adm(action, mode = null) {
            const body = {
                userId: tg.initDataUnsafe.user.id,
                action,
                data: {
                    title: document.getElementById('a-title').value,
                    link: document.getElementById('a-link').value,
                    targetId: document.getElementById('t-id').value,
                    amount: document.getElementById('t-amt').value,
                    mode: mode,
                    type: document.getElementById('p-type').value,
                    days: document.getElementById('p-days').value
                }
            };
            await fetch('/api/admin/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            init();
        }
        init();
    </script>
</body>
</html>
