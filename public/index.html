<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moon Project</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #05010a; color: white; font-family: sans-serif; margin: 0; overflow: hidden; touch-action: none; }
        
        /* –õ–û–ê–î–ï–† */
        #loading-screen { position: fixed; inset: 0; background: #05010a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .moon { width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, #fff, #888); box-shadow: 0 0 30px #fff; animation: p 2s infinite ease-in-out; }
        @keyframes p { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }

        /* –û–°–ù–û–í–ù–û–ï */
        #app { display: none; padding: 20px; height: 100vh; flex-direction: column; }
        .nick-ultra { background: linear-gradient(90deg, #bc42f5, #00bcd4, #bc42f5); background-size: 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: s 3s linear infinite; font-weight: 900; font-size: 22px; }
        @keyframes s { to { background-position: 200%; } }
        .sub-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #bc42f5; margin-left: 8px; vertical-align: middle; color: white; }

        .menu { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .item { background: #120520; border: 1px solid #2d1b4d; border-radius: 10px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        
        /* –ö–û–ù–°–û–õ–¨ */
        #console { display: none; position: fixed; inset: 0; background: rgba(5, 1, 10, 0.98); z-index: 10000; flex-direction: column; padding: 20px; overflow-y: auto; }
        .in { background: #120520; border: 1px solid #e91e63; border-radius: 8px; padding: 12px; color: white; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .btn { background: #1a0b35; border: 1px solid #e91e63; padding: 15px; border-radius: 10px; text-align: center; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        
        #char-prev { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; display: none; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="moon"></div>
        <p style="letter-spacing: 3px; margin-top: 20px; font-size: 12px; color: #555;">–ó–ê–ì–†–£–ó–ö–ê –ú–ò–†–ê...</p>
    </div>

    <div id="app">
        <div style="display:flex; justify-content:space-between;">
            <div>
                <span id="name" class="nick-default">User</span>
                <span id="badge" class="sub-tag" style="display:none;"></span>
                <div id="id-display" style="font-size:10px; color:#444;">ID: ---</div>
            </div>
            <div style="color:#ffcc00; font-size:24px;">üåô <span id="shards">0</span></div>
        </div>

        <div class="menu">
            <div class="item">–ß–∞—Ç—ã</div><div class="item">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
            <div class="item" style="border-color:#e91e63; color:#e91e63;" id="con-btn" onclick="openConsole()">–ö–û–ù–°–û–õ–¨</div>
        </div>
    </div>

    <div id="console">
        <h3 style="color:#e91e63; text-align:center;">SYSTEM TERMINAL</h3>
        
        <div id="c-main">
            <div class="btn" onclick="c_view('c-sub')">–ü–û–î–ü–ò–°–ö–ò</div>
            <div class="btn" onclick="c_view('c-char')">–ü–ï–†–°–û–ù–ê–ñ</div>
            <div class="btn" onclick="closeConsole()" style="border-color:#555;">–ó–ê–ö–†–´–¢–¨</div>
        </div>

        <div id="c-sub" style="display:none;">
            <input type="number" id="sub-id" placeholder="Telegram ID" class="in">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <div class="btn" onclick="setSub('Premium')">PREMIUM</div>
                <div class="btn" onclick="setSub('Ultra')">ULTRA</div>
            </div>
            <div class="btn" onclick="setSub('None')" style="border-color:red;">–°–ù–Ø–¢–¨ –í–°–Å</div>
            <div class="btn" onclick="c_view('c-main')">–ù–ê–ó–ê–î</div>
        </div>

        <div id="c-char" style="display:none;">
            <img id="char-prev">
            <input type="file" id="f" accept="image/*" style="display:none;" onchange="pv(this)">
            <div class="btn" onclick="document.getElementById('f').click()">üìÅ –í–´–ë–†–ê–¢–¨ –§–û–¢–û</div>
            <input type="text" id="cn" placeholder="–ò–ú–Ø" class="in">
            <input type="number" id="ca" placeholder="–í–û–ó–†–ê–°–¢ (18+)" class="in">
            <textarea id="cd" placeholder="–û–ü–ò–°–ê–ù–ò–ï (–û–¢ 30 –°–ò–ú–í.)" class="in" style="height:100px;"></textarea>
            <div class="btn" onclick="saveChar()" style="border-color:green;">–°–û–ó–î–ê–¢–¨</div>
            <div class="btn" onclick="c_view('c-main')">–ù–ê–ó–ê–î</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const OID = 8287041036;
        let imgData = "";

        // –ñ–ï–°–¢–ö–ò–ô –¢–ê–ô–ú–ï–† –õ–£–ù–´ (2.5 —Å–µ–∫ –∏ –æ–Ω–∞ –∏—Å—á–µ–∑–Ω–µ—Ç –ø–æ-–ª—é–±–æ–º—É)
        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        }, 2500);

        function openConsole() { document.getElementById('console').style.display = 'flex'; }
        function closeConsole() { document.getElementById('console').style.display = 'none'; }
        function c_view(id) {
            ['c-main', 'c-sub', 'c-char'].forEach(v => document.getElementById(v).style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        function pv(input) {
            if (input.files && input.files[0]) {
                let r = new FileReader();
                r.onload = e => { 
                    imgData = e.target.result;
                    document.getElementById('char-prev').src = imgData;
                    document.getElementById('char-prev').style.display = 'block';
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        async function setSub(type) {
            const tid = document.getElementById('sub-id').value;
            await fetch('/api/admin/manage-sub', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ owner_id: OID, target_id: tid, sub_type: type })
            });
            alert("–ì–æ—Ç–æ–≤–æ!"); location.reload();
        }

        async function saveChar() {
            const name = document.getElementById('cn').value;
            const age = document.getElementById('ca').value;
            const desc = document.getElementById('cd').value;
            if (desc.length < 30) return alert("–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ!");
            const r = await fetch('/api/admin/create-character', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ owner_id: OID, name, age, description: desc, image: imgData })
            });
            const d = await r.json(); alert(d.message || d.error);
            if(!d.error) location.reload();
        }

        window.onload = async () => {
            const user = tg.initDataUnsafe?.user || { id: OID, first_name: "Owner" };
            document.getElementById('id-display').innerText = "ID: " + user.id;
            document.getElementById('name').innerText = user.first_name;

            const res = await fetch('/api/user/get-data', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ tg_id: user.id })
            });
            const data = await res.json();
            
            document.getElementById('shards').innerText = (user.id == OID) ? "‚àû" : data.shards;
            
            let s = (user.id == OID) ? "Ultra" : data.subscription;
            if (s !== "None") {
                document.getElementById('name').className = "nick-ultra";
                document.getElementById('badge').innerText = s;
                document.getElementById('badge').style.display = 'inline-block';
            }
        };

        tg.expand();
        document.addEventListener('touchmove', (e) => e.preventDefault(), {passive: false});
    </script>
</body>
</html>
