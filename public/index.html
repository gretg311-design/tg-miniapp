<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Luna AI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --purple: #a020f0; --border: #301934; --dark: #000; }
        body { background: var(--dark); color: white; font-family: sans-serif; margin: 0; padding: 15px; }
        .header { border: 1px solid var(--border); border-radius: 20px; padding: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-name { font-weight: bold; font-style: italic; }
        .user-id { font-size: 10px; color: #888; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { background: #000; border: 1px solid var(--border); border-radius: 12px; padding: 20px 5px; text-align: center; text-transform: uppercase; font-weight: bold; font-size: 10px; cursor: pointer; }
        .btn.red { border-color: red; color: red; }
        .screen { display: none; flex-direction: column; width: 100%; }
        .active { display: flex; }
        input, select { width: 100%; background: #111; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; margin-top: 5px; margin-bottom: 10px; }
        .action-btn { background: var(--purple); border: none; color: white; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; }
    </style>
</head>
<body>
    <div id="m" class="screen active">
        <div class="header">
            <div><div id="un" class="user-name">LOADING...</div><div id="ui" class="user-id"></div></div>
            <div id="ub" style="color:var(--purple)">0</div>
        </div>
        <div class="grid">
            <div class="btn">–ß–∞—Ç—ã</div><div class="btn">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
            <div class="btn">–ï–∂–µ–¥–Ω–µ–≤–∫–∞</div><div class="btn">–ó–∞–¥–∞–Ω–∏—è</div>
            <div class="btn">–ú–∞–≥–∞–∑–∏–Ω</div><div class="btn">–ü—Ä–æ–º–æ–∫–æ–¥—ã</div>
            <div class="btn">–ü—Ä–æ—Ñ–∏–ª—å</div><div class="btn" onclick="openS('s')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="btn" id="ba" style="display:none">–ê–¥–º–∏–Ω–∫–∞</div>
            <div class="btn red" id="bc" style="display:none">–ö–æ–Ω—Å–æ–ª—å</div>
        </div>
    </div>
    <div id="s_screen" class="screen">
        <h3 style="color:var(--purple)">–ù–ê–°–¢–†–û–ô–ö–ò</h3>
        –ò–ú–Ø: <input id="in_n">
        –ü–û–õ: <select id="in_g"><option value="–ú—É–∂—Å–∫–æ–π">–ú</option><option value="–ñ–µ–Ω—Å–∫–∏–π">–ñ</option></select>
        –î–õ–ò–ù–ê –û–¢–í–ï–¢–ê: <input type="range" id="in_l">
        <button class="action-btn" onclick="save()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <p onclick="location.reload()" style="text-align:center; color:#888; margin-top:20px">‚óÄ –ù–∞–∑–∞–¥</p>
    </div>
    <script>
        const tg = window.Telegram.WebApp;
        const tgU = tg.initDataUnsafe?.user || { id: 8287041036, first_name: "Boss" };
        let u = null;
        fetch('/api/auth', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({tgId: tgU.id}) })
        .then(r => r.json()).then(d => {
            if(d.isNew) {
                fetch('/api/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({tgId: tgU.id, name: tgU.first_name, gender: '–ú—É–∂—Å–∫–æ–π'}) })
                .then(r => r.json()).then(newU => { u = newU; update(); });
            } else { u = d; update(); }
        });
        function update() {
            document.getElementById('un').innerHTML = u.name.toUpperCase() + (u.role === 'owner' ? ' <span style="color:red">(BOSS)</span>' : '');
            document.getElementById('ui').innerText = 'ID: ' + u.tgId;
            document.getElementById('ub').innerText = 'üåô ' + u.balance;
            if(u.role === 'owner' || u.role === 'admin') document.getElementById('ba').style.display = 'block';
            if(u.role === 'owner') document.getElementById('bc').style.display = 'block';
        }
        function openS(s) { document.getElementById('m').classList.remove('active'); document.getElementById('s_screen').classList.add('active'); document.getElementById('in_n').value = u.name; }
        function save() {
            fetch('/api/update-settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({tgId: u.tgId, name: document.getElementById('in_n').value, gender: document.getElementById('in_g').value, lengthOffset: document.getElementById('in_l').value}) })
            .then(() => location.reload());
        }
    </script>
</body>
</html>
