<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Project A-Z</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        
        #splash { position: fixed; inset: 0; background: #000; display: flex; justify-content: center; align-items: center; z-index: 1000; transition: 0.5s; }
        .moon { width: 100px; height: 100px; background: radial-gradient(circle at 30% 30%, #fff, #8a2be2 70%); border-radius: 50%; box-shadow: 0 0 50px #8a2be2; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        #main-app { display: none; flex-direction: column; height: 100vh; }
        .header { display: flex; justify-content: space-between; padding: 25px 20px 10px; }
        .u-name { color: #b026ff; font-weight: 800; font-size: 19px; }
        .balance { color: #ffa500; font-weight: 700; }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; flex-grow: 1; }
        .btn { background: rgba(40, 0, 70, 0.5); border: 1px solid rgba(138, 43, 226, 0.2); backdrop-filter: blur(10px); border-radius: 20px; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: 700; cursor: pointer; height: 90px; text-align: center; }
        .console-btn { border: 1px solid #f00; color: #f00; }

        .window { display: none; position: fixed; inset: 0; background: #000; z-index: 500; padding: 20px; overflow-y: auto; }
        .window.active { display: block; }
        .close-btn { margin-top: 20px; color: #8a2be2; text-align: center; font-weight: 800; cursor: pointer; }
        
        input, textarea, select { width: 100%; padding: 12px; background: #1a0033; border: 1px solid #8a2be2; color: #fff; border-radius: 12px; margin: 8px 0; box-sizing: border-box; }
        .footer { display: flex; justify-content: space-around; padding: 20px; border-top: 1px solid #222; }
    </style>
</head>
<body onload="init()">

<div id="splash"><div class="moon"></div></div>

<div id="main-app">
    <div class="header">
        <div class="u-name" id="h-name">...</div>
        <div class="balance">üåô <span id="h-shards">0</span></div>
    </div>

    <div id="menu-grid" class="menu-grid">
        <div class="btn" onclick="openW('chats')">–ß–ê–¢–´</div>
        <div class="btn" onclick="openW('chars')">–ü–ï–†–°–û–ù–ê–ñ–ò</div>
        <div class="btn" onclick="openW('daily')">–ï–ñ–ï–î–ù–ï–í–ö–ê</div>
        <div class="btn" onclick="openW('tasks')">–ó–ê–î–ê–ù–ò–Ø</div>
        <div class="btn" onclick="openW('shop')">–ú–ê–ì–ê–ó–ò–ù</div>
        <div class="btn" onclick="openW('promo')">–ü–†–û–ú–û–ö–û–î–´</div>
        <div class="btn" onclick="openW('profile')">–ü–†–û–§–ò–õ–¨</div>
        <div class="btn" onclick="openW('settings')">–ù–ê–°–¢–†–û–ô–ö–ò</div>
        <div class="btn" id="admin-node" onclick="openW('admin')">–ê–î–ú–ò–ù–ö–ê</div>
        <div class="btn console-btn" id="owner-node" onclick="openW('console')">–ö–û–ù–°–û–õ–¨</div>
    </div>

    <div id="w-reg" class="window">
        <h2>–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø 18+</h2>
        <input type="text" id="reg-name" placeholder="–¢–≤–æ–µ –∏–º—è">
        <select id="reg-gender"><option value="male">–ú—É–∂—á–∏–Ω–∞</option><option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option></select>
        <div class="btn" onclick="register()">–í–û–ô–¢–ò</div>
    </div>

    <div id="w-settings" class="window">
        <h2>–ù–ê–°–¢–†–û–ô–ö–ò</h2>
        <p>–ü–æ—à–ª–æ—Å—Ç—å (1-6):</p>
        <input type="range" min="1" max="6" id="v-range">
        <p>–î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:</p>
        <input type="range" min="45" max="100" id="l-range">
        <div class="close-btn" onclick="closeW()">–ù–ê–ó–ê–î</div>
    </div>

    <div id="w-admin" class="window">
        <h2>–ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨</h2>
        <input type="text" id="c-name" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
        <input type="text" id="c-age" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
        <textarea id="c-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–ò–ò –±—É–¥–µ—Ç –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ –Ω–µ–≥–æ)"></textarea>
        <div class="btn" onclick="addChar()">–°–û–ó–î–ê–¢–¨ –ü–ï–†–°–û–ù–ê–ñ–ê</div>
        <div class="close-btn" onclick="closeW()">–ù–ê–ó–ê–î</div>
    </div>

    <div id="w-console" class="window">
        <h2 style="color:red">–ö–û–ù–°–û–õ–¨ –û–í–ù–ï–†–ê</h2>
        <input type="text" placeholder="Telegram ID">
        <div class="btn" style="margin-bottom:5px">–í–´–î–ê–¢–¨ –ü–û–î–ü–ò–°–ö–£</div>
        <div class="btn" style="margin-bottom:5px">–ò–ó–ú–ï–ù–ò–¢–¨ –¶–ï–ù–´</div>
        <div class="close-btn" onclick="closeW()">–ù–ê–ó–ê–î</div>
    </div>

    <div id="w-chats" class="window"><h2>–í–ê–®–ò –ß–ê–¢–´</h2><div id="chat-cont"></div><div class="close-btn" onclick="closeW()">–ù–ê–ó–ê–î</div></div>
    <div id="w-chars" class="window"><h2>–í–°–ï –ü–ï–†–°–û–ù–ê–ñ–ò</h2><div id="char-cont"></div><div class="close-btn" onclick="closeW()">–ù–ê–ó–ê–î</div></div>

    <div class="footer"><div onclick="closeW()">‚óÄ –ù–ê–ó–ê–î</div><div onclick="showHome()">üè† –î–û–ú–û–ô</div></div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    const OWNER_ID = "8287041036";
    let myId = "0";

    async function init() {
        const tg = window.Telegram.WebApp;
        tg.expand();
        myId = tg.initDataUnsafe?.user?.id?.toString() || new URLSearchParams(window.location.search).get('tgId') || OWNER_ID;

        const res = await fetch(`/api/get-user?tgId=${myId}`);
        const data = await res.json();

        setTimeout(() => {
            document.getElementById('splash').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('splash').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                if (data.exists) {
                    document.getElementById('h-name').innerText = data.user.name.toUpperCase();
                    document.getElementById('h-shards').innerText = data.user.shards;
                    if(myId !== OWNER_ID) document.getElementById('owner-node').style.display = 'none';
                } else { openW('reg'); }
            }, 500);
        }, 2000);
    }

    function openW(id) {
        document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
        document.getElementById('w-' + id).classList.add('active');
        if(id === 'chars') loadChars();
    }

    function closeW() { document.querySelectorAll('.window').forEach(w => w.classList.remove('active')); }
    function showHome() { closeW(); }

    async function register() {
        const name = document.getElementById('reg-name').value;
        const gender = document.getElementById('reg-gender').value;
        await fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ tgId: myId, name, gender })
        });
        location.reload();
    }

    async function addChar() {
        const name = document.getElementById('c-name').value;
        const age = document.getElementById('c-age').value;
        const desc = document.getElementById('c-desc').value;
        await fetch('/api/admin/add-char', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, age, desc, creatorId: myId })
        });
        alert('–ü–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ–∑–¥–∞–Ω!');
        closeW();
    }

    async function loadChars() {
        const res = await fetch('/api/chars');
        const chars = await res.json();
        document.getElementById('char-cont').innerHTML = chars.map(c => `
            <div class="btn" style="margin-bottom:10px" onclick="startChat('${c._id}')">${c.name}, ${c.age}</div>
        `).join('');
    }
</script>
</body>
</html>
