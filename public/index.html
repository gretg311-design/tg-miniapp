const tg = window.Telegram.WebApp;
tg.expand();

const userData = tg.initDataUnsafe.user || { id: 8287041036, first_name: "BOSS" };

async function init(retries = 5) {
    try {
        const res = await fetch('/api/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ tgId: userData.id, name: userData.first_name })
        });

        if (!res.ok) throw new Error('–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª –æ—à–∏–±–∫–æ–π');

        const data = await res.json();
        
        // –£–±–∏—Ä–∞–µ–º –ª—É–Ω—É
        document.getElementById('loader').style.display = 'none';
        
        // –ù–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–º–∏
        const nameEl = document.getElementById('u-name');
        nameEl.innerText = data.name + (data.role === 'owner' ? ' (BOSS)' : '');
        if(data.role === 'owner') nameEl.classList.add('boss');
        
        document.getElementById('u-bal').innerText = data.role === 'owner' ? 'üåô ‚àû' : 'üåô ' + (data.balance || 0);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω–∫—É/–∫–æ–Ω—Å–æ–ª—å
        if(data.role === 'owner' || data.role === 'admin') document.getElementById('adm').style.display = 'block';
        if(data.role === 'owner') document.getElementById('own').style.display = 'block';

        window.scrollTo(0, document.body.scrollHeight);

    } catch (e) {
        if (retries > 0) {
            console.log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è... –æ—Å—Ç–∞–ª–æ—Å—å ${retries}`);
            setTimeout(() => init(retries - 1), 1500); // –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫
        } else {
            document.getElementById('u-name').innerText = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ!";
            alert("–õ—É–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç —Å–≤—è–∑–∞—Ç—å—Å—è —Å –±–∞–∑–æ–π. –ü—Ä–æ–≤–µ—Ä—å MONGO_URL –∏ IP Access –≤ Atlas!");
        }
    }
}
init();
