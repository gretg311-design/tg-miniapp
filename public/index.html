<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --neon: #bc13fe; --glass: rgba(15, 5, 25, 0.98); --border: rgba(188, 19, 254, 0.5); }
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; touch-action: none; }
        .screen { display: none; height: calc(100vh - 70px); flex-direction: column; overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .active { display: flex; }
        .glass { background: var(--glass); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .menu-btn { height: 80px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 11px; font-weight: bold; border: 1px solid var(--border); border-radius: 15px; background: rgba(188, 19, 254, 0.05); text-transform: uppercase; cursor: pointer; }
        .btn-main { width: 100%; padding: 15px; background: var(--neon); border: none; color: #fff; border-radius: 12px; font-weight: bold; margin-top: 10px; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: var(--glass); border-top: 1px solid var(--neon); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #0c0212; border: 1px solid var(--neon); color: #fff; border-radius: 10px; box-sizing: border-box; }
        .char-card { display: flex; align-items: center; gap: 15px; position: relative; }
        .char-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; border: 1px solid var(--neon); }
        #layer-cap, #layer-reg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="layer-cap">
    <h1 style="color:var(--neon); font-size: 40px;">18+</h1>
    <p>–ö–æ–Ω—Ç–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö.<br>–í–∞–º –µ—Å—Ç—å 18 –ª–µ—Ç?</p>
    <button class="btn-main" onclick="showReg()">–î–ê, –ú–ù–ï –ï–°–¢–¨ 18</button>
    <button class="btn-main" style="background: #333;" onclick="tg.close()">–ù–ï–¢</button>
</div>

<div id="layer-reg" style="display:none">
    <div class="glass">
        <h2>–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</h2>
        <input id="reg-name" placeholder="–¢–≤–æ–µ –∏–º—è">
        <select id="reg-gender"><option value="–ú">–ú—É–∂—Å–∫–æ–π –ø–æ–ª</option><option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π –ø–æ–ª</option></select>
        <button class="btn-main" onclick="startApp()">–ù–ê–ß–ê–¢–¨ –ü–†–ò–ö–õ–Æ–ß–ï–ù–ò–ï</button>
    </div>
</div>

<div id="scr-main" class="screen">
    <div class="glass" style="display:flex; justify-content:space-between; align-items:center;">
        <div><b id="u-name" style="color:var(--neon)">...</b><br><small id="u-id"></small></div>
        <div>üåô <b id="u-bal">0</b></div>
    </div>
    <div class="menu-grid">
        <div class="menu-btn" onclick="openMod('chats')">–ß–∞—Ç—ã</div>
        <div class="menu-btn" onclick="openMod('chars')">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
        <div class="menu-btn" onclick="openMod('daily')">–ï–∂–µ–¥–Ω–µ–≤–∫–∞</div>
        <div class="menu-btn" onclick="openMod('tasks')">–ó–∞–¥–∞–Ω–∏—è</div>
        <div class="menu-btn" onclick="openMod('shop')">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="menu-btn" onclick="openMod('promo')">–ü—Ä–æ–º–æ–∫–æ–¥—ã</div>
        <div class="menu-btn" onclick="openMod('profile')">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="menu-btn" onclick="openMod('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div id="adm-btn" class="menu-btn" style="display:none" onclick="openMod('admin')">–ê–¥–º–∏–Ω–∫–∞</div>
        <div id="cons-btn" class="menu-btn" style="display:none; color:red; border-color:red" onclick="openMod('console')">–ö–æ–Ω—Å–æ–ª—å</div>
    </div>
</div>

<div id="scr-mod" class="screen"><div id="mod-content"></div></div>

<nav class="bottom-nav">
    <div onclick="goHome()">üè† –î–û–ú–û–ô</div>
    <div onclick="goBack()">‚óÄ –ù–ê–ó–ê–î</div>
</nav>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    let user = {}, allChars = [], allItems = [], tempPhoto = "";

    function showReg() {
        document.getElementById('layer-cap').style.display='none';
        document.getElementById('layer-reg').style.display='flex';
        const raw = tg.initDataUnsafe.user || {id: "8287041036", first_name: "Owner"};
        document.getElementById('reg-name').value = raw.first_name;
    }

    async function startApp() {
        const raw = tg.initDataUnsafe.user || {id: "8287041036"};
        const res = await fetch('/api/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: raw.id, name: document.getElementById('reg-name').value, gender: document.getElementById('reg-gender').value })
        });
        const data = await res.json();
        user = data.user; allChars = data.chars; allItems = data.items;
        document.getElementById('layer-reg').style.display='none';
        document.getElementById('scr-main').classList.add('active');
        renderMain();
    }

    function renderMain() {
        document.getElementById('u-name').innerText = user.name + (user.role==='owner'?' (BOSS)':'');
        document.getElementById('u-id').innerText = "ID: " + user.id;
        document.getElementById('u-bal').innerText = user.balance;
        if(user.role==='owner' || user.role==='admin') document.getElementById('adm-btn').style.display='flex';
        if(user.role==='owner') document.getElementById('cons-btn').style.display='flex';
    }

    function openMod(type) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('scr-mod').classList.add('active');
        const cont = document.getElementById('mod-content');
        let html = `<div class="glass"><h2>${type.toUpperCase()}</h2>`;

        if(type === 'console') {
            html += `<b>–î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†</b><input id="in-n" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><input id="in-p" type="number" placeholder="–¶–µ–Ω–∞"><select id="in-c"><option value="Stars">Stars</option><option value="USD">USD</option></select><button class="btn-main" onclick="manageItem('add')">–°–û–ó–î–ê–¢–¨ –¢–û–í–ê–†</button><hr>`;
            html += `<b>–ù–û–í–´–ô –ü–ï–†–°–û–ù–ê–ñ</b><input id="c-n" placeholder="–ò–º—è"><input id="c-a" type="number" placeholder="–í–æ–∑—Ä–∞—Å—Ç"><textarea id="c-d" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea><input type="file" onchange="encodePhoto(this)"><button class="btn-main" onclick="manageChar('add')">–°–û–ó–î–ê–¢–¨ –ü–ï–†–°–ê –î–õ–Ø –í–°–ï–•</button>`;
        } else if(type === 'chars') {
            allChars.forEach(c => {
                html += `<div class="glass char-card"><img src="${c.photo || 'https://via.placeholder.com/60'}" class="char-img"><div><b>${c.name}, ${c.age}</b><br><small>${c.desc}</small></div>${user.role==='owner' ? `<button onclick="manageChar('delete', '${c._id}')" style="position:absolute; right:10px; background:red; border:none; color:#fff; border-radius:5px;">‚ùå</button>` : ''}</div>`;
            });
        } else if(type === 'shop') {
            allItems.length ? allItems.forEach(i => {
                html += `<div class="glass" style="display:flex; justify-content:space-between; align-items:center;"><span>${i.name}<br><small>${i.price} ${i.currency}</small></span><button class="btn-main" style="width:auto; margin:0; padding:10px 20px;" onclick="tg.showAlert('–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ ${i.currency}...')">–ö–£–ü–ò–¢–¨</button></div>`;
            }) : html += `<p>–í –º–∞–≥–∞–∑–∏–Ω–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ.</p>`;
        }
        cont.innerHTML = html + `</div>`;
    }

    function encodePhoto(input) {
        const reader = new FileReader();
        reader.onload = (e) => { tempPhoto = e.target.result; };
        reader.readAsDataURL(input.files[0]);
    }

    async function manageChar(action, id) {
        const charData = action==='add' ? {name: document.getElementById('c-n').value, age: document.getElementById('c-a').value, desc: document.getElementById('c-d').value, photo: tempPhoto} : null;
        const res = await fetch('/api/manage-char', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action, charData, id, userId: user.id}) });
        const data = await res.json(); allChars = data.chars; openMod('chars');
    }

    async function manageItem(action, id) {
        const itemData = {name: document.getElementById('in-n').value, price: document.getElementById('in-p').value, currency: document.getElementById('in-c').value};
        const res = await fetch('/api/manage-item', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action, itemData, id, userId: user.id}) });
        const data = await res.json(); allItems = data.items; tg.showAlert("–ú–∞–≥–∞–∑–∏–Ω –æ–±–Ω–æ–≤–ª–µ–Ω!");
    }

    function goHome() { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById('scr-main').classList.add('active'); }
    function goBack() { goHome(); }
    document.addEventListener('touchmove', (e) => { if (!e.target.closest('.screen')) e.preventDefault(); }, { passive: false });
</script>
</body>
</html>
