<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0b0f1a; --card: #161b2c; --accent: #3b82f6; --gold: #fbc02d; }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; overflow: hidden; background: var(--bg); color: white; font-family: sans-serif; }
        .screen { display: none; height: 100vh; overflow-y: auto; padding-bottom: 50px; }
        .active { display: block; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card); border-bottom: 1px solid #232d4b; sticky: top; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .btn { background: var(--card); padding: 25px 10px; border-radius: 18px; text-align: center; border: 1px solid #232d4b; font-weight: bold; font-size: 11px; }
        .card { background: var(--card); margin: 10px; padding: 15px; border-radius: 15px; border: 1px solid #232d4b; }
        .back-btn { width: 90%; margin: 15px 5%; padding: 15px; background: #232d4b; color: white; border: none; border-radius: 12px; }
        input { width: 100%; padding: 15px; margin: 10px 0; background: #0b1121; border: 1px solid var(--accent); color: white; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="scr-main" class="screen active">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="u-img" src="" style="width:45px; border-radius:50%; border:2px solid var(--accent);">
                <div><b id="u-n">...</b><br><span id="u-role" style="font-size:10px; color:var(--gold)">USER</span></div>
            </div>
            <div id="u-b" style="background:#1e253d; padding:5px 12px; border-radius:20px; font-weight:bold;">üåô 0</div>
        </div>
        <div class="menu-grid">
            <div class="btn" onclick="tab('scr-chats')">üí¨ –ß–ê–¢–´</div>
            <div class="btn" onclick="tab('scr-chars')">üßç –ì–ï–†–û–ò</div>
            <div class="btn" onclick="tg.showAlert('–ë–æ–Ω—É—Å +10üåô –ø–æ–ª—É—á–µ–Ω!')">üéÅ –ë–û–ù–£–°</div>
            <div class="btn" onclick="tab('scr-tasks')">üìã –ó–ê–î–ê–ù–ò–Ø</div>
            <div class="btn" onclick="tab('scr-shop')">üõí –ú–ê–ì–ê–ó–ò–ù</div>
            <div class="btn" onclick="tab('scr-promo')">üéü –ö–û–î–´</div>
            <div class="btn" onclick="tab('scr-profile')">üë§ –ü–†–û–§–ò–õ–¨</div>
            <div class="btn" onclick="tab('scr-opts')">‚öôÔ∏è –û–ü–¶–ò–ò</div>
            <div class="btn" onclick="tg.showAlert('–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç')">üì¢ –ò–í–ï–ù–¢–´</div>
            <div class="btn" onclick="tg.showAlert('–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">üèÜ –¢–û–ü</div>
            <button id="adm-btn" class="btn" style="display:none; background:red; color:white;" onclick="tab('scr-admin')">üíª –ê–î–ú–ò–ù–ö–ê</button>
        </div>
    </div>

    <div id="scr-chars" class="screen"><h2 style="padding:15px;">–ì–µ—Ä–æ–∏</h2><div id="char-list"></div><button class="back-btn" onclick="tab('scr-main')">–ù–ê–ó–ê–î</button></div>
    
    <div id="scr-tasks" class="screen"><h2 style="padding:15px;">–ó–∞–¥–∞–Ω–∏—è</h2><div id="task-list"></div><button class="back-btn" onclick="tab('scr-main')">–ù–ê–ó–ê–î</button></div>

    <div id="scr-shop" class="screen">
        <h2 style="padding:15px;">–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div class="card">
            <small>–í–∞—à –∫–æ–¥ –æ–ø–ª–∞—Ç—ã:</small>
            <h1 id="my-code" style="color:var(--gold);">ID000</h1>
            <button onclick="copyAddr()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:12px; color:white; font-weight:bold;">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ö–æ—à–µ–ª–µ–∫</button>
        </div>
        <button class="back-btn" onclick="tab('scr-main')">–ù–ê–ó–ê–î</button>
    </div>

    <div id="scr-admin" class="screen">
        <h2 style="padding:15px;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
        <div class="card">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
            <input type="text" id="a-t-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <input type="text" id="a-t-link" placeholder="–°—Å—ã–ª–∫–∞">
            <button onclick="admAct('add_task')" style="width:100%; padding:15px; background:green; color:white; border:none; border-radius:12px;">–î–û–ë–ê–í–ò–¢–¨</button>
        </div>
        <div id="owner-only" style="display:none;" class="card">
            <h3>–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∞ (–û–≤–Ω–µ—Ä)</h3>
            <input type="number" id="new-adm-id" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <button onclick="admAct('set_admin')" style="width:100%; padding:15px; background:blue; color:white; border:none; border-radius:12px;">–ù–ê–ó–ù–ê–ß–ò–¢–¨</button>
        </div>
        <button class="back-btn" onclick="tab('scr-main')">–ù–ê–ó–ê–î</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let role = 'user';

        function tab(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function init() {
            const res = await fetch('/api/init/' + tg.initDataUnsafe.user.id);
            const data = await res.json();
            role = data.role;
            
            document.getElementById('u-n').innerText = data.user.name;
            document.getElementById('u-b').innerText = "üåô " + data.user.balance;
            document.getElementById('u-role').innerText = role.toUpperCase();
            document.getElementById('u-img').src = tg.initDataUnsafe.user.photo_url || "https://via.placeholder.com/45";
            document.getElementById('my-code').innerText = "ID" + tg.initDataUnsafe.user.id;

            if(role === 'owner' || role === 'admin') document.getElementById('adm-btn').style.display = 'block';
            if(role === 'owner') document.getElementById('owner-only').style.display = 'block';

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–¥–∞–Ω–∏–π (—Å –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –û–≤–Ω–µ—Ä–∞)
            const tl = document.getElementById('task-list'); tl.innerHTML = "";
            data.tasks.forEach(t => {
                let delBtn = (role === 'owner') ? `<button onclick="admAct('del_task', ${t.id})" style="background:red; border:none; color:white; padding:5px; border-radius:5px; margin-left:10px;">–£–¥–∞–ª–∏—Ç—å</button>` : '';
                tl.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><span>${t.title}</span><div><button onclick="window.open('${t.link}')">–ü–µ—Ä–µ–π—Ç–∏</button>${delBtn}</div></div>`;
            });
        }

        async function admAct(action, id = null) {
            let data = id ? { id } : { title: document.getElementById('a-t-title').value, link: document.getElementById('a-t-link').value, newId: document.getElementById('new-adm-id').value };
            await fetch('/api/admin/action', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId: tg.initDataUnsafe.user.id, action, data })
            });
            init();
        }

        function copyAddr() {
            navigator.clipboard.writeText("UQCm8mTj_LHm0DyCvpNOs8PtwDqfrr_BjDSoJVJnm81WO08d");
            tg.showAlert("–ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
        }

        init();
    </script>
</body>
</html>
