<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const tgUser = tg.initDataUnsafe?.user || { id: 8287041036, first_name: "BOSS" };
    let user = null;

    function init() {
        fetch('/api/auth', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({tgId: tgUser.id}) 
        })
        .then(res => res.json())
        .then(data => {
            if (data.isNew) {
                // Если юзер новый, регистрируем его автоматом для теста или просим пол
                register();
            } else {
                user = data;
                renderUI();
            }
        });
    }

    function register() {
        fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({tgId: tgUser.id, name: tgUser.first_name, gender: 'Мужской'})
        })
        .then(res => res.json())
        .then(data => { user = data; renderUI(); });
    }

    function renderUI() {
        document.getElementById('u-name').innerHTML = user.name + (user.role === 'owner' ? ' <span style="color:red">(BOSS)</span>' : '');
        document.getElementById('u-id').innerText = 'ID: ' + user.tgId;
        document.getElementById('u-bal').innerText = user.balance;
        if(user.role === 'owner' || user.role === 'admin') document.getElementById('btn-adm').style.display = 'block';
        if(user.role === 'owner') document.getElementById('btn-con').style.display = 'block';
    }

    init();
</script>
