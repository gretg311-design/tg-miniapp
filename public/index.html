<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --neon: #bc13fe; --glass: rgba(15, 5, 25, 0.98); --border: rgba(188, 19, 254, 0.5); }
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        .screen { display: none; height: calc(100vh - 70px); flex-direction: column; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .active { display: flex; }
        .glass { background: var(--glass); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .btn-main { width: 100%; padding: 15px; background: var(--neon); border: none; color: #fff; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; background: #0c0212; border: 1px solid var(--neon); color: #fff; border-radius: 10px; box-sizing: border-box; }
        #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div id="cap-box" class="glass" style="text-align:center;">
        <h1 style="color:var(--neon)">18+</h1>
        <p>–í–∞–º –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å 18 –ª–µ—Ç?</p>
        <button class="btn-main" onclick="showReg()">–î–ê, –ú–ù–ï –ï–°–¢–¨ 18</button>
    </div>
    <div id="reg-box" class="glass" style="display:none; width:90%;">
        <h2>–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</h2>
        <input id="r-name" placeholder="–¢–≤–æ–µ –∏–º—è">
        <select id="r-gen"><option value="–ú">–ú—É–∂—Å–∫–æ–π –ø–æ–ª</option><option value="–ñ">–ñ–µ–Ω—Å–∫–∏–π –ø–æ–ª</option></select>
        <button id="save-btn" class="btn-main" onclick="finishReg()">–ù–ê–ß–ê–¢–¨</button>
    </div>
</div>

<div id="scr-main" class="screen">
    <div class="glass" style="display:flex; justify-content:space-between; align-items:center">
        <div><b id="u-name" style="color:var(--neon)">...</b><br><small id="u-id"></small></div>
        <div>üåô <b id="u-bal">0</b></div>
    </div>
    
    <div id="owner-box" class="glass" style="display:none; border-color:red;">
        <h3 style="color:red; margin:0 0 10px 0;">–ö–û–ù–°–û–õ–¨ –û–í–ù–ï–†–ê</h3>
        <input id="tid" placeholder="TG ID –¶–µ–ª–∏">
        <input id="tval" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ (—á–∏—Å–ª–æ/—Ä–æ–ª—å)">
        <button class="btn-main" onclick="doAdmin('addBalance')">–í—ã–¥–∞—Ç—å –û—Å–∫–æ–ª–∫–∏</button>
        <button class="btn-main" style="background:#444;" onclick="doAdmin('setRole')">–ù–∞–∑–Ω–∞—á–∏—Ç—å –†–æ–ª—å</button>
    </div>

    <div class="glass">
        <h3>–ú–ï–ù–Æ</h3>
        <p>–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞: <span id="u-sub">Free</span></p>
        <p>–ü—Ä–æ–µ–∫—Ç "–æ—Ç –ê –¥–æ –Ø" –∑–∞–ø—É—â–µ–Ω!</p>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    let user = {};

    function showReg() {
        document.getElementById('cap-box').style.display = 'none';
        document.getElementById('reg-box').style.display = 'block';
        const raw = tg.initDataUnsafe.user || {id: "8287041036", first_name: "Owner"};
        document.getElementById('r-name').value = raw.first_name || "";
    }

    async function finishReg() {
        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerText = "–ó–ê–ì–†–£–ó–ö–ê...";
        const raw = tg.initDataUnsafe.user || {id: "8287041036"};

        try {
            const res = await fetch('/api/auth', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: String(raw.id),
                    name: document.getElementById('r-name').value,
                    gender: document.getElementById('r-gen').value
                })
            });
            const data = await res.json();
            user = data.user;
            
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('scr-main').classList.add('active');
            
            document.getElementById('u-name').innerText = user.name + (user.role === 'owner' ? ' (–ë–û–°–°)' : '');
            document.getElementById('u-id').innerText = "ID: " + user.id;
            document.getElementById('u-bal').innerText = user.balance;
            document.getElementById('u-sub').innerText = user.sub;
            
            if (user.role === 'owner') document.getElementById('owner-box').style.display = 'block';
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
            btn.disabled = false; btn.innerText = "–ù–ê–ß–ê–¢–¨";
        }
    }

    async function doAdmin(action) {
        const res = await fetch('/api/admin/control', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                senderId: String(user.id),
                targetId: document.getElementById('tid').value,
                value: document.getElementById('tval').value,
                action: action
            })
        });
        const d = await res.json();
        tg.showAlert(d.success ? "–ì–æ—Ç–æ–≤–æ!" : "–û—à–∏–±–∫–∞");
    }
</script>
</body>
</html>
