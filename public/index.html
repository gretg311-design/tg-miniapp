<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --neon: #bc13fe; --glass: rgba(20, 5, 30, 0.95); --border: rgba(188, 19, 254, 0.5); }
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; touch-action: none; }
        .screen { display: none; height: calc(100vh - 70px); flex-direction: column; overflow-y: auto; padding: 10px; }
        .active { display: flex; }
        .glass { background: var(--glass); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-bottom: 10px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .menu-btn { height: 80px; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 11px; font-weight: bold; border: 1px solid var(--border); border-radius: 15px; text-transform: uppercase; cursor: pointer; }
        .menu-btn:active { background: var(--neon); transform: scale(0.95); }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: var(--glass); border-top: 1px solid var(--neon); display: flex; justify-content: space-around; align-items: center; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #1a0525; border: 1px solid var(--neon); color: #fff; border-radius: 10px; }
        .btn-main { width: 100%; padding: 15px; background: var(--neon); border: none; color: #fff; border-radius: 10px; font-weight: bold; }
        .btn-red { background: #ff4444; margin-top: 5px; }
    </style>
</head>
<body>

<div id="scr-main" class="screen active">
    <div class="glass" style="display:flex; justify-content:space-between; align-items:center;">
        <div><b id="u-name">–ó–∞–≥—Ä—É–∑–∫–∞...</b><br><small id="u-id" style="color:#aaa;"></small></div>
        <div style="color:var(--neon)">üåô <b id="u-bal">0</b></div>
    </div>
    <div class="menu-grid">
        <div class="menu-btn" onclick="renderMod('chats')">–ß–∞—Ç—ã</div>
        <div class="menu-btn" onclick="renderMod('chars')">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
        <div class="menu-btn" onclick="renderMod('daily')">–ï–∂–µ–¥–Ω–µ–≤–∫–∞</div>
        <div class="menu-btn" onclick="renderMod('tasks')">–ó–∞–¥–∞–Ω–∏—è</div>
        <div class="menu-btn" onclick="renderMod('shop')">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="menu-btn" onclick="renderMod('promo')">–ü—Ä–æ–º–æ–∫–æ–¥—ã</div>
        <div class="menu-btn" onclick="renderMod('profile')">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="menu-btn" onclick="renderMod('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div id="adm-btn" class="menu-btn" style="display:none" onclick="renderMod('admin')">–ê–¥–º–∏–Ω–∫–∞</div>
        <div id="cons-btn" class="menu-btn" style="display:none; color:red; border-color:red" onclick="renderMod('console')">–ö–æ–Ω—Å–æ–ª—å</div>
    </div>
</div>

<div id="scr-mod" class="screen"><div id="mod-body"></div></div>

<nav class="bottom-nav">
    <div onclick="goHome()">üè† –î–û–ú–û–ô</div>
    <div onclick="goBack()">‚óÄ –ù–ê–ó–ê–î</div>
</nav>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();

    let user = {};
    let appData = { chars: [], tasks: [] };

    async function init() {
        const raw = tg.initDataUnsafe.user || { id: "8287041036", first_name: "German" };
        const res = await fetch('/api/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: raw.id, name: raw.first_name })
        });
        const data = await res.json();
        user = data.user;
        appData.chars = data.chars;
        appData.tasks = data.tasks;
        updateUI();
    }

    function updateUI() {
        document.getElementById('u-name').innerText = user.name + (user.role === 'owner' ? " (BOSS)" : "");
        document.getElementById('u-id').innerText = "ID: " + user.id;
        document.getElementById('u-bal').innerText = user.balance;
        if(user.role === 'owner' || user.role === 'admin') document.getElementById('adm-btn').style.display = 'flex';
        if(user.role === 'owner') document.getElementById('cons-btn').style.display = 'flex';
    }

    function renderMod(type) {
        document.getElementById('scr-main').classList.remove('active');
        document.getElementById('scr-mod').classList.add('active');
        const body = document.getElementById('mod-body');
        
        let html = `<div class="glass"><h2>${type.toUpperCase()}</h2>`;

        switch(type) {
            case 'settings':
                html += `<input id="set-n" value="${user.name}"><select id="set-g"><option value="–ú">–ú—É–∂—á–∏–Ω–∞</option><option value="–ñ">–ñ–µ–Ω—â–∏–Ω–∞</option></select>
                         <button class="btn-main" onclick="saveSets()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`;
                break;
            case 'daily':
                html += `<p>–°—Ç—Ä–∏–∫: ${user.streak}</p><h1>+500 üåô</h1><button class="btn-main" onclick="alert('–ó–∞–±—Ä–∞–ª!')">–ó–ê–ë–†–ê–¢–¨</button>`;
                break;
            case 'chars':
                appData.chars.forEach(c => {
                    html += `<div class="glass"><b>${c.name}, ${c.age}</b><br><small>${c.desc}</small></div>`;
                });
                break;
            case 'console':
            case 'admin':
                const isO = (user.role === 'owner' && type === 'console');
                html += `<b>–°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞</b><input placeholder="–ò–º—è"><textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea><button class="btn-main">–°–æ–∑–¥–∞—Ç—å</button>
                         <hr><b>–†–µ—Å—É—Ä—Å—ã (ID)</b><input id="target-id" placeholder="TG ID"><input placeholder="–ö–æ–ª-–≤–æ"><button class="btn-main">–í—ã–¥–∞—Ç—å</button>`;
                if(isO) html += `<button class="btn-main btn-red">–°–Ω—è—Ç—å</button><hr><b>–ê–¥–º–∏–Ω—ã</b><input placeholder="ID"><button class="btn-main">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button><button class="btn-main btn-red">–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞</button>`;
                break;
            default:
                html += `<p>–†–∞–∑–¥–µ–ª –≤ —Ä–∞–±–æ—Ç–µ...</p>`;
        }
        body.innerHTML = html + `</div>`;
    }

    async function saveSets() {
        const name = document.getElementById('set-n').value;
        const gender = document.getElementById('set-g').value;
        await fetch('/api/save-settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: user.id, name, gender })
        });
        location.reload();
    }

    function goHome() { document.getElementById('scr-mod').classList.remove('active'); document.getElementById('scr-main').classList.add('active'); }
    function goBack() { goHome(); }

    init();
</script>
</body>
</html>
