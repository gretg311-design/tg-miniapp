<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–õ—É–Ω–Ω—ã–π –ë–æ—Ç</title>
    <style>
        :root {
            --glass-bg: rgba(48, 10, 86, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
            --moon-color: #e0d0ff;
        }
        body { 
            background: #05010a; color: var(--moon-color); font-family: 'Segoe UI', sans-serif;
            margin: 0; overflow-y: auto; touch-action: pan-y;
            -webkit-user-select: none; /* –û—Ç–∫–ª—é—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
            user-select: none;
        }
        .screen { display: none; padding: 20px; }
        .active { display: block; }

        /* –ö—Ä–∞—Å–∏–≤–∞—è –ø—É–ª—å—Å–∏—Ä—É—é—â–∞—è –ª—É–Ω–∞ */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        .pulsing-moon {
            font-size: 100px; line-height: 1; text-align: center;
            animation: pulse 2s infinite ease-in-out;
            color: var(--moon-color); text-shadow: 0 0 20px var(--moon-color);
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–µ–∫–ª–∞ */
        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 15px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.2);
            padding: 15px; margin: 10px auto; max-width: 90%;
        }
        .btn-glass {
            @extend .glass-panel; /* –Ω–∞—Å–ª–µ–¥—É–µ–º —Å—Ç–∏–ª–∏ —Å—Ç–µ–∫–ª–∞ */
            background: rgba(80, 20, 140, 0.7); /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ */
            text-align: center; cursor: pointer;
            transition: background 0.3s ease;
        }
        .btn-glass:hover { background: rgba(100, 30, 160, 0.8); }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
            @extend .glass-panel;
            border-radius: 0 0 15px 15px; /* –¢–æ–ª—å–∫–æ –Ω–∏–∑ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π */
            margin: 0; padding: 10px 15px;
        }
        .header-left, .header-right { display: flex; flex-direction: column; }
        .header-right span { cursor: pointer; margin-left: 5px; }

        /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            display: flex; justify-content: space-around; align-items: center;
            background: rgba(10, 2, 18, 0.9); /* –ü–æ—á—Ç–∏ —á–µ—Ä–Ω—ã–π, –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }
        .nav-item {
            color: var(--moon-color); font-size: 24px; cursor: pointer;
            padding: 5px 15px; border-radius: 8px;
            transition: background 0.3s ease;
        }
        .nav-item.active-nav { background: rgba(80, 20, 140, 0.7); }
        .nav-item:hover { background: rgba(60, 15, 110, 0.5); }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
        input[type="text"], input[type="number"], select {
            width: calc(100% - 20px); padding: 10px; margin: 5px 0;
            border-radius: 8px; border: 1px solid var(--border-color);
            background: rgba(20, 5, 30, 0.7); color: var(--moon-color);
            box-sizing: border-box;
        }
        /* –°–µ—Ç–∫–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        .grid-buttons {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; padding: 15px;
        }
        /* –ê–¥–º–∏–Ω/–û–≤–Ω–µ—Ä –∫–Ω–æ–ø–∫–∏ */
        .admin-btn { border-color: gold; color: gold; }
        .owner-btn { border-color: red; color: red; }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active" style="text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100vh;">
        <div class="pulsing-moon">üåô</div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</p>
    </div>

    <div id="reg-screen" class="screen glass-panel" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%;">
        <h2 style="text-align: center;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ 18+</h2>
        <input type="text" id="reg-name" placeholder="–í–∞—à–µ –∏–º—è">
        <select id="reg-gender">
            <option value="male">–ú—É–∂—á–∏–Ω–∞</option>
            <option value="female">–ñ–µ–Ω—â–∏–Ω–∞</option>
        </select>
        <div class="btn-glass" onclick="registerUser()" style="margin-top: 20px;">–í–æ–π—Ç–∏</div>
    </div>

    <div id="main-app" class="screen">
        <div class="header">
            <div class="header-left">
                <b id="user-display-name">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
                <small id="user-display-id">ID: ...</small>
                <small id="user-display-sub" style="color: #bc8cff;">–ü–æ–¥–ø–∏—Å–∫–∞: Free</small>
            </div>
            <div class="header-right">
                <span id="user-display-shards">0</span> üåô <span onclick="showTab('shop')">[+]</span>
            </div>
        </div>

        <div id="chats-tab" class="screen active">
            <h3>–ß–∞—Ç—ã</h3>
            <div class="grid-buttons" id="chat-list">
                <div class="btn-glass">–ß–∞—Ç —Å –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–º 1</div>
                <div class="btn-glass">–ß–∞—Ç —Å –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–º 2</div>
            </div>
        </div>

        <div id="characters-tab" class="screen">
            <h3>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h3>
            <div class="grid-buttons" id="characters-gallery">
                <div class="btn-glass">–ü–µ—Ä—Å–æ–Ω–∞–∂ –ê</div>
                <div class="btn-glass">–ü–µ—Ä—Å–æ–Ω–∞–∂ –ë</div>
            </div>
        </div>

        <div id="daily-tab" class="screen">
            <h3>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞</h3>
            <div class="btn-glass">–ó–∞–±—Ä–∞—Ç—å üåô (–°—Ç—Ä–∏–∫: 1/7)</div>
        </div>

        <div id="promocode-tab" class="screen">
            <h3>–ü—Ä–æ–º–æ–∫–æ–¥</h3>
            <input type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥">
            <div class="btn-glass">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</div>
        </div>

        <div id="tasks-tab" class="screen">
            <h3>–ó–∞–¥–∞–Ω–∏—è</h3>
            <div class="grid-buttons">
                <div class="btn-glass">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª</div>
            </div>
        </div>

        <div id="shop-tab" class="screen">
            <h3>–ú–∞–≥–∞–∑–∏–Ω</h3>
            <div class="grid-buttons">
                <div class="btn-glass">–ü–∞–∫ –æ—Å–∫–æ–ª–∫–æ–≤ (Stars)</div>
                <div class="btn-glass">–ü–∞–∫ –æ—Å–∫–æ–ª–∫–æ–≤ (TON)</div>
                <div class="btn-glass">–ü–æ–¥–ø–∏—Å–∫–∞ Pro (Stars)</div>
                <div class="btn-glass">–ü–æ–¥–ø–∏—Å–∫–∞ Ultra (TON)</div>
            </div>
        </div>
        
        <div id="profile-tab" class="screen">
            <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
            <div class="glass-panel">
                <p>–ù–∏–∫: <span id="profile-name"></span></p>
                <p>ID: <span id="profile-id"></span></p>
                <p>–ë–∞–ª–∞–Ω—Å: <span id="profile-shards"></span> üåô</p>
                <p>–ü–æ–¥–ø–∏—Å–∫–∞: <span id="profile-sub"></span></p>
                <p>–ü–æ–ª: <span id="profile-gender"></span></p>
            </div>
        </div>

        <div id="settings-tab" class="screen">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="glass-panel">
                <p>–°–º–µ–Ω–∞ –∏–º–µ–Ω–∏:</p><input type="text" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
                <p>–°–º–µ–Ω–∞ –ø–æ–ª–∞:</p><select><option>–ú—É–∂—á–∏–Ω–∞</option><option>–ñ–µ–Ω—â–∏–Ω–∞</option></select>
                <p>–ü–æ—à–ª–æ—Å—Ç—å (1-6): <span id="vulgarity-level">1</span></p>
                <input type="range" min="1" max="6" value="1" id="vulgarity-slider">
                <p>–î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π: <span id="length-level">45</span> —Å–ª–æ–≤</p>
                <input type="range" min="45" max="100" value="45" id="length-slider">
            </div>
        </div>

        <div id="admin-tab" class="screen">
            <h3>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h3>
            <div class="grid-buttons">
                <div class="btn-glass">–°–æ–∑–¥–∞—Ç—å –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</div>
                <div class="btn-glass">–í—ã–¥–∞—Ç—å –ü–æ–¥–ø–∏—Å–∫—É/–û—Å–∫–æ–ª–∫–∏</div>
            </div>
        </div>

        <div id="owner-tab" class="screen">
            <h3>üëë –ö–û–ù–°–û–õ–¨ –û–í–ù–ï–†–ê</h3>
            <div class="grid-buttons">
                <div class="btn-glass owner-btn">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ê–¥–º–∏–Ω–∞–º–∏</div>
                <div class="btn-glass owner-btn">–¶–µ–Ω—ã –ú–∞–≥–∞–∑–∏–Ω–∞</div>
                <div class="btn-glass owner-btn">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ó–∞–¥–∞–Ω–∏—è–º–∏</div>
                <div class="btn-glass owner-btn">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏</div>
                <div class="btn-glass owner-btn">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ë–∞–ª–∞–Ω—Å</div>
                <div class="btn-glass owner-btn">–ü—Ä–æ–º–æ–∫–æ–¥—ã</div>
                <div class="btn-glass owner-btn">–†–∞—Å—Å—ã–ª–∫–∞</div>
                <div class="btn-glass owner-btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ü–æ–¥–ø–∏—Å–∫–∏</div>
                <div class="btn-glass owner-btn">–õ–æ–≥–∏ –°–∏—Å—Ç–µ–º—ã</div>
                <div class="btn-glass owner-btn">–°–±—Ä–æ—Å –î–∞–Ω–Ω—ã—Ö</div>
            </div>
        </div>

        <nav class="nav-bar">
            <div class="nav-item active-nav" onclick="showTab('chats-tab')">üí¨</div>
            <div class="nav-item" onclick="showTab('characters-tab')">üë•</div>
            <div class="nav-item" onclick="showTab('daily-tab')">üéÅ</div>
            <div class="nav-item" onclick="showTab('promocode-tab')">üé´</div>
            <div class="nav-item" onclick="showTab('tasks-tab')">üìã</div>
            <div class="nav-item" onclick="showTab('shop-tab')">üíé</div>
            <div class="nav-item" onclick="showTab('profile-tab')">üë§</div>
            <div class="nav-item" onclick="showTab('settings-tab')">‚öôÔ∏è</div>
            <div class="nav-item" id="nav-admin-btn" style="display:none;" onclick="showTab('admin-tab')">üõ°Ô∏è</div>
            <div class="nav-item" id="nav-owner-btn" style="display:none;" onclick="showTab('owner-tab')">üëë</div>
        </nav>
    </div>

<script>
    const OWNER_ID = "8287041036";
    let currentUser = null; // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ pull-to-refresh
    window.addEventListener('touchmove', (e) => {
        if (window.scrollY === 0 && e.touches[0].pageY > 0) e.preventDefault();
    }, { passive: false });

    document.addEventListener('DOMContentLoaded', initApp);

    async function initApp() {
        let tgId;
        try {
            // –í —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏: const tg = window.Telegram.WebApp; tgId = tg.initDataUnsafe.user.id;
            // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:
            tgId = new URLSearchParams(window.location.search).get('tgId') || OWNER_ID; 
        } catch (e) {
            console.warn("Telegram WebApp API –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π TG ID.", e);
            tgId = OWNER_ID; 
        }

        console.log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è TG ID: ${tgId}`);

        try {
            const response = await fetch(`/api/get-user?tgId=${tgId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            setTimeout(() => { // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π –ª—É–Ω—ã
                document.getElementById('loading-screen').classList.remove('active');
                if (data.exists) {
                    currentUser = data.user;
                    renderMainApp(tgId);
                } else {
                    document.getElementById('reg-screen').classList.add('active');
                }
            }, 2000); // 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑–∞ –ª—É–Ω—ã
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            document.getElementById('loading-screen').innerHTML = '<h1 style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!</h1><p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>';
        }
    }

    async function registerUser() {
        const tgId = new URLSearchParams(window.location.search).get('tgId') || OWNER_ID; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ ID –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        const name = document.getElementById('reg-name').value;
        const gender = document.getElementById('reg-gender').value;

        if (!name) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è."); return; }

        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tgId, name, gender })
            });
            const data = await response.json();

            if (response.ok) {
                currentUser = data.user;
                document.getElementById('reg-screen').classList.remove('active');
                renderMainApp(tgId);
            } else {
                alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + data.error);
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.");
        }
    }

    function renderMainApp(tgId) {
        document.getElementById('main-app').classList.add('active');
        document.getElementById('user-display-name').innerText = currentUser.name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
        document.getElementById('user-display-id').innerText = `ID: ${tgId}`;
        document.getElementById('user-display-shards').innerText = currentUser.shards === "‚àû" ? "‚àû" : currentUser.shards;
        document.getElementById('user-display-sub').innerText = `–ü–æ–¥–ø–∏—Å–∫–∞: ${currentUser.subscription || 'Free'}`;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        document.getElementById('profile-name').innerText = currentUser.name || "N/A";
        document.getElementById('profile-id').innerText = tgId;
        document.getElementById('profile-shards').innerText = currentUser.shards === "‚àû" ? "‚àû" : currentUser.shards;
        document.getElementById('profile-sub').innerText = currentUser.subscription || 'Free';
        document.getElementById('profile-gender').innerText = currentUser.gender || '–ù–µ —É–∫–∞–∑–∞–Ω';


        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∞/–æ–≤–Ω–µ—Ä–∞
        if (tgId === OWNER_ID) {
            document.getElementById('nav-owner-btn').style.display = 'flex';
            document.getElementById('nav-admin-btn').style.display = 'flex'; // –û–≤–Ω–µ—Ä –≤–∏–¥–∏—Ç –∏ –∞–¥–º–∏–Ω—Å–∫—É—é
        } else if (currentUser.isAdmin) { // –î–æ–ø—É—Å—Ç–∏–º, –º—ã –¥–æ–±–∞–≤–∏–º –ø–æ–ª–µ isAdmin –≤ –º–æ–¥–µ–ª—å User
            document.getElementById('nav-admin-btn').style.display = 'flex';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
        if (currentUser.settings) {
            document.getElementById('vulgarity-slider').value = currentUser.settings.vulgarity;
            document.getElementById('vulgarity-level').innerText = currentUser.settings.vulgarity;
            document.getElementById('length-slider').value = currentUser.settings.msgLength;
            document.getElementById('length-level').innerText = currentUser.settings.msgLength;
        }

        // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–æ–≤
        document.getElementById('vulgarity-slider').oninput = function() {
            document.getElementById('vulgarity-level').innerText = this.value;
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        };
        document.getElementById('length-slider').oninput = function() {
            document.getElementById('length-level').innerText = this.value;
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        };
    }

    function showTab(tabId) {
        document.querySelectorAll('.screen').forEach(s => {
            if (s.id.endsWith('-tab')) { // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∫–ª–∞–¥–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                s.classList.remove('active');
            }
        });
        document.getElementById(tabId).classList.add('active');

        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active-nav'));
        const activeNavItem = document.querySelector(`[onclick="showTab('${tabId}')"]`);
        if (activeNavItem) activeNavItem.classList.add('active-nav');
    }

    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏: –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 'chats-tab'
    showTab('chats-tab');

</script>
</body>
</html>
